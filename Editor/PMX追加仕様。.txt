PMXとMQOの互換性に重大な懸念が発生している。
PMXライブラリを整理する必要がある。
頂点順序の入れ替えは厳禁である。
・CSV関連のルーチンはいったん放棄
・PMXのReadWriteを作り直す。
・頂点のソートは厳禁
PMXのReadにおいて、まず頂点を読む。メッシュオブジェクトに分割する際、オブジェクト単位で頂点を分割する。原則、１材質が１オブジェクトであるが、次のような例外が存在する。

例えばオブジェクト手首指には、手首肌と手爪という材質があり頂点が混在している。これは一つのオブジェクトにまとめ、頂点順序は入れ替えてはならない。PMXでは、オブジェクトという概念がないため、材質のメモ欄をCSVデータとして利用し、ObjectName,オブジェクト名　というデータを格納する。
オブジェクト名が同じものは材質単位で頂点を分割せず、オブジェクト名で一括した頂点リストとしてあつかう。面リストは並び替えてもよいが同一材質内での並び順は保持する（厳守）。

下記はメモ欄の例。

材質名 手首肌001  のMemo "ObjectName,手首指"
材質名 手爪 のMemo       "ObjectName,手首指"
材質名 手首肌001+ のMemo "ObjectName,手首指,IsMirror"
材質名 手爪+ のMemo      "ObjectName,手首指,IsMirror"

ミラーをベイクする際の材質の並び順は上記の通りまず材質ごとに実体側の頂点を順序通りに並べ、次に再度ミラー材質ごとにミラー並べる。


内部では
メッシュコンテキスト手首指ができる。そこには手首肌001と手爪が入る。
また、
メッシュコンテキスト手首指+ができる（BakedMirrorフラグが立つ）。そこには手首肌001+と手爪+が入る。



なお、IsMirrorは必須ではないこととする（書き込みは行う）。

まずPMXインポータとPMXエクスポータのメソッドを上記の仕様に応じて置き換えよ。各メソッドは外部から共有利用できるようにせよ。
メッシュオブジェクトごとに、頂点数やUV展開後の頂点数が得られるようにしておくこと。
他のパネルから共有利用できるようなヘルパーメソッドとせよ。同じようなメソッドを複数作ることは厳禁

---------------------
現状の問題点と打開策
問題点
1. 頂点順序（位相）の破綻
MQOで1オブジェクトに複数材質が混在している場合、PMXエクスポート時に頂点順序が破綻する。
例：
頂点0-677: 手首肌001
頂点678: 手爪
頂点697: 手首肌001
頂点698: 手爪
頂点699: 手首肌001
...
材質が入り乱れて頂点が配置されるため、材質群マッチングアルゴリズム（面の順序で位相を保持する仕組み）が機能しない。
2. モーフのBefore/After対応が不可能
位相が破綻すると、モーフ用のBefore/Afterモデル間で頂点の対応関係が取れなくなる。
打開策
PMXモデルの材質Memo欄にObjectNameを設定する
材質Memoの形式（CSV、順不同）：
ObjectName,左手,IsMirror
または
IsMirror,ObjectName,左手

ObjectName,名前 - オブジェクト名を指定
IsMirror - ミラーとして扱う（省略時はミラーとして扱わない）

設定例：
材質名Memo手首肌001ObjectName,左手手爪ObjectName,左爪手首肌001+ObjectName,左手,IsMirror手爪+ObjectName,左爪,IsMirror
効果

PMXインポート時にObjectNameでオブジェクトが分割される
頂点群が材質ごとに分離される
MQO編集後のPMXエクスポートで位相が保持される
モーフのBefore/After対応が可能になる

備考

ほとんどのオブジェクトは1オブジェクト1材質であり、修正は最小限で済む
特殊面用のM(0)は除く



理解したらソースコードを送る。
理解したか?
